---
title:  "L1 生存分析简介"
date: today
author: 
  name: "李宗璋"
  url: https://space.bilibili.com/590872906/
format: 
  revealjs:
    incremental: FALSE
    theme: sky
    slide-number: true
    code-fold: true
    chalkboard: 
      buttons: true
    preview-links: auto
    css: styles.css
    footer: |
      <https://lizongzhang.github.io/survival><br>© 2025 医咖会 Li Zongzhang 
    include-before-body: 
      - header.html
      - fonts.html
    title-slide-attributes: 
      data-background-image: "img/yikahui_qcr.png"  
      data-background-size: "100px"        
      data-background-position: "center bottom 200px"  
    plugins: [highlight, zoom, notes]
editor: 
  markdown: 
    wrap: 72
---

```{r}
#| echo: FALSE
par(family  = 'STKaiti')
library(showtext)
showtext_auto()

# install.packages("survival")
# install.packages("ggsurvfit")
# install.packages("gtsummary")
# install.packages("tidyverse")

library(survival)
library(ggsurvfit)
library(gtsummary)
library(tidyverse)
```

## 1 生存分析简介

1.1 什么是生存分析？

1.2 为什么要使用生存分析方法？

1.3 生存分析的核心概念

1.4 生存分析方法概览

1.5 为什么选择 R 实现生存分析？

------------------------------------------------------------------------

## 1.1 什么是生存分析？

生存分析研究事件发生的时间及其发生概率。

生存分析 Survival Analysis：删失数据

右删失数据 right censoring

> 右删失数据指由于观察时间结束或其他原因，仅知事件在某时间点尚未发生，而无法获知具体发生时间的数据。

- 研究病人的生存时间

  -   有些病人在研究结束时还活着，只知道他们的生存时间“大于某个值”
  
  -   有些病人中途退出了研究，只知道他们的生存时间“大于某个值”

-------

### 举例

研究某种疾病的患者的年龄(X)对生存时间(Y)的影响

-   患者A：患者A：60岁，生存5年后死亡，生存时间为5年。

-   患者B：50岁，研究结束时(第6年)还活着，生存时间的数据是“至少6年”。

-   患者C：65岁，中途退出了研究，退出研究时(第3年)还活着，生存时间的数据是“至少3年”。

------------------------------------------------------------------------

### 为什么不能用线性回归？

-   线性回归要求因变量(如生存时间)为确切观测值，但右删失数据仅提供‘至少某值’，将其作为真实值会导致生存时间低估和结果偏差。

-   线性回归要求每个样本的因变量(比如“生存时间”)都是真实观测到的，

-   但右删失的样本，你只知道“生存时间至少为某个值”，不是确切值。

-   如果你把删失的样本直接当作“真实值”输入，会低估实际生存时间，得到有偏的回归结果。

------------------------------------------------------------------------

### 为什么不能用logistic回归？

-   logistic回归仅关注事件是否发生，忽略时间维度，导致无法捕捉事件的动态变化，丢失时间相关信息。

-   忽略时间会导致信息丢失，模型无法捕捉事件的动态性。

> 生存分析：考虑时间因素，正确利用“至少生存多久”的信息。

------------------------------------------------------------------------

### 生存分析 Survival Analysis的别称

-   可靠性分析(Reliability analysis)

-   持续时间分析(Duration analysis)

-   事件历史分析(Event history analysis)

-   时间-事件分析(Time-to-event analysis)

------------------------------------------------------------------------

### 生存分析场景

| 应用场景 | 事件(Event) | 时间(Time) |
|------------------|------------------|------------------------------------|
| 治疗方案效果评估 | 死亡 | 从开始接受某种治疗方案起，到该事件发生所经历的时间 |
| 再就业 | 重新找到工作 | 从失业开始，到重新就业所经历的时间 |
| 邮件投递 | 邮件成功送达 | 从寄出(或邮局接收)到信件被成功投递所经历的时间 |
| 急救响应 | 救护车到达呼救者所在位置 | 从拨打急救电话到救护车到达现场所经历的时间 |

-----

## 1.2 生存分析的优势

生存分析能同时考虑事件发生时间和处理删失数据，精确反映事件的动态过程。

生存分析

-   比较不同治疗组事件发生的时间长短。

-   估计中位生存时间。

-   分析某因素对事件发生时间的加速或延迟效应。

-----------

## 1.3 生存分析的核心术语


-  生存时间 Survival Time

-  删失数据 Censoring Data

-   生存函数 Survival Function, S(t)

-   累积分布函数(Cumulative Distribution Function, F(t))

-   风险函数 Hazard Function, h(t)

---

### 生存时间 Survival Time

  - 定义：从一个明确起点到特定事件发生的时间长度。事件可以是死亡、故障、复发等任何感兴趣的结果。

  - 举例
  
    -   癌症患者从确诊开始到死亡的天数

    -   一台机器从启动到第一次故障的小时数

---

### 删失数据 (Censoring Data)

  - 定义：由于观察限制，我们无法知道事件确切发生时间的样本。即只知道事件“至少”发生了多久，比如研究结束时事件还没发生。

  - 举例

    - 研究结束时，患者，只知还健在，只知道他至少存活了6年”。
  
    - 研究中途，患者失访，只知道他至少存活了3年”。


----

###  生存函数 Survival Function, S(t)

- 生存函数 $S(t)$ 表示在时间 $t$ 后事件仍未发生的概率，即 $P(T > t)$。
。
- 数学定义：
  $$
  S(t) = P(T > t)
  $$
  - $T$：随机变量，表示生存时间(或到事件发生的时间)
  - $t$：某一具体时间点

    -   定义：表示在某个时间$t$之后，事件仍未发生的概率。它回答“有多大概率能‘存活’到某个时间点”。

    -   举例
    
      -   5年后，接受了治疗的患者，有60%的概率还活着, S(5)=0.6
      
      -   某产品出厂后一年后有90%还没坏，S(1)=0.9




---

### 生存时间的累积分布函数(Cumulative Distribution Function, F(t))

  - 定义：累积分布函数F(t)表示“生存时间小于等于t”的概率，即在时间t之前事件已经发生的概率。F(t) 与生存函数 S(t) 满足：F(t) = 1 - S(t)。

  - 举例
  
    - “5年内，40%的患者已经死亡。”也就是说，F(5) = 0.4。
  
    - 某产品出厂后一年内有10%已经发生故障，F(1)=0.1。

> 累积分布函数和生存函数是互补的，F(t) 侧重于“事件已发生”，S(t) 侧重于“事件尚未发生”。

---

### 风险函数 Hazard Function, h(t)

- 风险函数 $h(t)$ 表示在时间 $t$ 仍未发生事件的条件下，事件在下一瞬间发生的条件概率速率。

- 数学定义：
  $$
  h(t) = \lim_{\Delta t \to 0} \frac{P(t \leq T < t+\Delta t \mid T \geq t)}{\Delta t}
  $$
  - $h(t)$：在 $t$ 时刻的瞬时风险率
  - $\Delta t$：很小的时间增量
  - $P(\cdot)$：概率

    -   定义：在“已经生存到t时刻”的前提下，“在下一个瞬间事件发生的瞬时概率”，反映了事件发生的“速率”或“风险强度”。

    -   举例：某患者在第3年时的风险函数为0.08，意味着已经活到第3年的患者，在第3年死亡的瞬时风险为0.08。

----

数学公式中的符号解释

| 符号     | 含义                                      |
|----------|-------------------------------------------|
| $T$      | 生存时间(随机变量)                      |
| $t$      | 具体时间点                                |
| $S(t)$   | 生存函数，$P(T > t)$                      |
| $h(t)$   | 风险函数，在时刻 $t$ 的瞬时风险率         |
| $f(t)$   | 生存时间的概率密度函数                    |
| $F(t)$   | 生存时间的分布函数，$F(t) = P(T \leq t)$  |


---

### 生存函数与风险函数的关系

  $$
  h(t) = -\frac{d}{dt} \log S(t)
  $$

- **推导过程：**
  
  Step 1: 生存函数 $S(t) = P(T>t) = 1 - P(T \leq t) = 1 -  F(t)$ , 求S(t)的导数，得：
     $$
     \frac{dS(t)}{dt} = -f(t)
     $$
  
  Step 2: 风险函数 $h(t)$ 的定义式：
    $$
  h(t) = \lim_{\Delta t \to 0} \frac{P(t \leq T < t+\Delta t \mid T \geq t)}{\Delta t} = \frac{ \frac {P(t \leq T < t+\Delta t)}{P(T \geq t)}}{\Delta t}=\frac{ \frac {f(t)\Delta t}{S(t)}}{\Delta t} = \frac{f(t)}{S(t)}
  $$
  
----

  Step 3:结合上面两式：
     
$$
     h(t) = \frac{f(t)}{S(t)} = \frac{ -\frac{dS(t)}{dt} }{ S(t) } = -\frac{d}{dt} \log S(t)
$$
     
---

Step 4: 积分得到生存函数公式

- 两边积分，得：
$$
  \frac{d}{dt}\ln S(t) = -h(t)
$$
  
$$
  \int_0^t \frac{d}{du}\ln S(u)\,du = -\int_0^t h(u)\,du
$$
---

- 左边是 $\ln S(t) - \ln S(0)$，而 $S(0) = 1$：
  $$
  \ln S(t) = -\int_0^t h(u)\,du
  $$
- 两边取指数：
  $$
  S(t) = \exp\left(-\int_0^t h(u)\,du\right)
  $$


  -  $\int_0^t h(u) du$ 被称为“累计风险函数”(cumulative hazard function)，记作 $H(t)$。
  - 即 $S(t) = \exp(-H(t))$

---

### 直观理解

- **生存函数 $S(t)$**：描述“还没发生事件的概率”。
- **风险函数 $h(t)$**：描述“此刻还没发生事件，马上发生事件的速率”。
- **联系**：
    - $h(t)$ 是 $S(t)$ 的对数导数的相反数。
    - $S(t)$ 是 $h(t)$ 的负积分的指数。
- **累计风险函数 $H(t)$** 是二者的桥梁：$H(t) = \int_0^t h(u) du$，$S(t) = \exp(-H(t))$。

---

## 生存函数图像特征

- $S(t)$ 随时间递减，$h(t)$ 描述何时“递减得快”。
- 若 $h(t)$ 恒定(如指数分布)，$S(t)$ 是指数函数。
- 若 $h(t)$ 随时间变化(如Weibull分布)，$S(t)$ 递减速率随时间变化。

---

## 1.4 生存分析方法

-   非参数模型

    -   Kaplan-Meier, Nelson-Aalen, Life Table

-   半参数模型

    -   Cox proportional hazards model

-   参数模型

    -   加速失效时间模型

-   机器学习模型

------------------------------------------------------------------------

### 非参数模型(Nonparametric Models)

非参数模型不假设生存时间分布，完全基于观测数据估计生存函数或风险函数。

-   Kaplan-Meier法(KM)

    -   适用于右删失数据，逐步估计生存函数
    -   每个事件时点重新计算生存概率
    -   可绘制生存曲线，进行组间比较

-   Nelson-Aalen法

    -   用于估计累积风险函数(cumulative hazard)

    -   与Kaplan-Meier方法互为补充

-   Life Table法(寿命表法)

    -   将时间划分为等距区间
    -   在每一时间段内估计死亡概率、生存概率
    -   常用于大样本或行政登记数据(如人口、保险)

--------

### 半参数模型(Semi-parametric Models)

-   Cox比例风险模型(Cox Proportional Hazards Model)

    -   最常用的回归模型
    -   假设不同个体间的风险比(hazard ratio)恒定
    -   不对基线风险函数作分布假设
    -   适用于分析协变量如何影响事件发生风险的比例关系

-   优点

    -   模型简洁，结果易解释
    -   适用于高维协变量、多因素控制的研究场景

-   限制

    -   依赖“比例风险假设”的成立

-----

### 参数模型(Parametric Models)

参数模型对生存时间作出**明确的分布假设**，如指数分布、Weibull分布、对数正态分布等。

-   加速失效时间模型(Accelerated Failure Time, AFT)

    -   假设协变量通过**加速或减缓失效进程**来影响生存时间
    -   模型形式为：对数生存时间 = 线性组合 + 误差项
    -   适用于时间尺度建模与预测任务

-   优点

    -   可获得精确预测和可靠的剩余生存时间估计
    -   适合工业可靠性分析与临床治疗效果评估

-   常见分布

    -   Weibull(韦布尔)
    -   Log-logistic(对数逻辑斯蒂)
    -   Log-normal(对数正态)


--

### 机器学习模型(Machine Learning Models) 

- 生存随机森林(Random Survival Forests)

- Boosting算法(GBM-Survival)

- 支持向量生存模型(Survival SVM)

- 神经网络方法(如基于深度神经网络的生存分析模型 DeepSurv)


---

### 生存分析方法

| 方法类型 | 代表模型 | 特点 | 应用场景 |
|------------------|------------------|------------------|-------------------|
| 非参数模型 | KM, Nelson-Aalen | 无分布假设，直观，稳健 | 初始分析，绘图，可视化 |
| 半参数模型 | Cox比例风险模型 | 相对风险解释，回归灵活 | 多因素建模，临床风险评估 |
| 参数模型 | Weibull, AFT模型 | 明确分布假设，可预测生存期 | 工程寿命预测，疗效量化研究 |
| 机器学习模型 | RSF, DeepSurv, SVM-Surv | 非线性建模，预测力强 | 高维数据，非线性复杂关系 |

------------------------------------------------------------------------

## 1.5 为什么用R进行生存分析？

-   支持多样化模型，与学术前沿同步

-   功能强大的包

-   满足学术出版标准，图形可直接用于SCI期刊投稿

-   代码的可重复性

-   支持与Python、SAS、Stata等软件的数据格式兼容，可读写CSV、Excel、SPSS、SQL等多种格式文件

------------------------------------------------------------------------

## ✅ 模型灵活、接轨学术前沿

-   非参数模型(如 Kaplan-Meier、Nelson-Aalen)；
-   半参数模型(Cox 回归、Stratified Cox、Time-dependent Cox)；
-   参数模型(Weibull、Exponential、Log-normal 等)；
-   加速失效时间模型(AFT)；
-   机器学习与深度学习方法(如随机生存森林、DeepSurv)；
-   支持删失数据、竞争风险、多状态模型、复发事件等复杂结构。

------------------------------------------------------------------------

## ✅ 包丰富、兼容性强

R 拥有生态完备的生存分析工具包，涵盖建模、可视化、诊断与预测的全过程：

-   `survival`: 生存分析的核心包，作者 Therneau 教授即为 Cox
    模型奠基人；
-   `survminer`: 专注于可视化与图表美化；
-   `rms`: 构建回归模型、估计 nomogram；
-   `flexsurv`: 拓展参数模型族，支持自定义分布；
-   `pec`、`riskRegression`: 用于模型评价、比较与预测；
-   `randomForestSRC`, `survivalmodels`: 接入机器学习与深度学习模型。

此外，R 与 Python、SAS、Stata 等平台的数据格式高度兼容，可轻松读写
CSV、Excel、SPSS、SAS、SQL、JSON 等多种格式文件。

------------------------------------------------------------------------

## ✅ 可视化：科学性与美学并重

R 的图形系统(尤其是 `ggplot2` 与 `survminer`)能兼顾：

-   **科学严谨性**：提供风险表(risk
    table)、置信区间、删失符号、分层比较、调整协变量；
-   **审美专业性**：高分辨率输出、分面展示、支持 LaTeX
    数学符号、主题统一；
-   **投稿级品质**：图形可直接用于 SCI
    期刊投稿，无需再由图形编辑软件二次加工。

常见输出格式包括 PDF、PNG、SVG、EPS，广泛支持矢量图形与学术出版标准。

------------------------------------------------------------------------

## ✅ 代码的可重复性(Reproducibility)

-   支持 R Markdown、Quarto 等文档系统，将文本、公式、代码与图表融合；
-   支持版本控制(Git)、自动更新、参数化分析；
-   每一步分析都可追溯，保证数据处理和建模过程的透明性；
-   与 `renv`、`packrat`
    等工具协同，确保包版本一致性，适用于课题组协作、期刊审稿再现和同行验证。

-------------

## 总结


| 概念 | 解释 |
|--------------------|----------------------------------------------------|
| 生存时间(T) | 个体从起点到目标事件发生所经历的时间 |
| 删失(Censoring) | 由于观察限制，事件发生时间未知的样本 |
| 生存函数 S(t) | 在时间 t 时刻事件尚未发生的概率，即 P(T > t) |
| 累积分布函数 F(t) | P(T ≤ t)，即事件在时间 t 前发生的概率 |
| 风险函数 h(t) | 在时间 t 时刻，事件尚未发生的个体中事件“立刻”发生的瞬时速率 |

